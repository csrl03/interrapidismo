<!DOCTYPE html>    <form id="formDocumento" class="form-section">
      <label for="documento">N√∫mero de Documento</label>
      <input type="text" id="documento" required placeholder="Ingrese n√∫mero de documento">
      <button type="submit" class="btn">A√±adir/Seleccionar Documento</button>
    </form>
    
    <!-- Control General de Rastreos -->
    <div id="controlGeneral" class="form-section">
      <h3 class="section-title">üìä Control General de Rastreos</h3>
      <div class="control-actions">
        <button id="btnRefreshControl" class="btn btn-secondary">üîÑ Actualizar Lista</button>
        <span id="totalRastreos" class="total-counter">Total: 0 rastreos</span>
      </div>
      <div id="tablaControlGeneral" class="control-table-container">
        <p class="loading-message">Cargando datos...</p>
      </div>
    </div>
    
    <div id="rastreosPrevios" class="form-section" style="display:none;">`l lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administraci√≥n de Ingresos - Inter Rapid√≠simo</title>
  <link rel="stylesheet" href="stylesDatos.css">
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <img src="logo.png" alt="Logo Interrapid√≠simo">
      <h2>Panel de Administraci√≥n</h2>
    </div>
    <hr class="divider">
    <form id="formDocumento" class="form-section">
      <label for="documento">N√∫mero de Documento</label>
      <input type="text" id="documento" required placeholder="Ingrese n√∫mero de documento">
      <button type="submit" class="btn">A√±adir/Seleccionar Documento</button>
    </form>
    <div id="rastreosPrevios" class="form-section" style="display:none;">
      <h3>Rastreos asociados</h3>
      <table class="data-table">
        <thead>
          <tr>
            <th>Gu√≠a</th>
            <th>Destino</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tablaPrevios"></tbody>
      </table>
    </div>
    <form id="formRastreo" class="form-section" style="display:none;">
      <h3 class="section-title">üì¶ Informaci√≥n General del Env√≠o</h3>
      <div class="field-group">
        <label for="guia">N√∫mero de Gu√≠a</label>
        <input type="text" id="guia" required placeholder="Ingrese n√∫mero de gu√≠a">
        <label for="admision">Fecha de Admisi√≥n</label>
        <input type="date" id="admision" required>
        <label for="estimada">Fecha Estimada de Entrega</label>
        <input type="date" id="estimada" required>
      </div>

      <h3 class="section-title">üë§ Datos del Destinatario</h3>
      <div class="field-group">
        <label for="destinoNombre">Nombre Completo</label>
        <input type="text" id="destinoNombre" required placeholder="Nombre del destinatario">
        <label for="destinoCedula">C√©dula</label>
        <input type="text" id="destinoCedula" required placeholder="N√∫mero de c√©dula">
        <label for="destinoTelefono">Tel√©fono</label>
        <input type="text" id="destinoTelefono" required placeholder="N√∫mero de contacto">
        <label for="destinoCiudad">Ciudad</label>
        <input type="text" id="destinoCiudad" required placeholder="Ciudad de destino">
        <label for="destinoDireccion">Direcci√≥n</label>
        <input type="text" id="destinoDireccion" required placeholder="Direcci√≥n completa">
      </div>

      <h3 class="section-title">üì§ Datos del Remitente</h3>
      <div class="field-group">
        <label for="origenNombre">Nombre Completo</label>
        <input type="text" id="origenNombre" required placeholder="Nombre del remitente">
        <label for="origenCedula">C√©dula</label>
        <input type="text" id="origenCedula" required placeholder="N√∫mero de c√©dula">
        <label for="origenTelefono">Tel√©fono</label>
        <input type="text" id="origenTelefono" required placeholder="N√∫mero de contacto">
        <label for="origenCiudad">Ciudad</label>
        <input type="text" id="origenCiudad" required placeholder="Ciudad de origen">
        <label for="origenDireccion">Direcci√≥n</label>
        <input type="text" id="origenDireccion" required placeholder="Direcci√≥n completa">
      </div>

      <h3 class="section-title">üìã Informaci√≥n del Paquete</h3>
      <div class="field-group">
        <label for="empaque">Tipo de Empaque</label>
        <input type="text" id="empaque" required placeholder="Descripci√≥n del empaque">
      </div>

      <button type="submit" class="btn">A√±adir Rastreo</button>
    </form>
    <div id="rastreoSection" class="form-section" style="display:none;">
      <h3>Rastreo del Env√≠o</h3>
      <form id="formActualizacion">
        <label for="ciudadAct">Ciudad</label>
        <input type="text" id="ciudadAct" required>
        <label for="estadoAct">Estado</label>
        <input type="text" id="estadoAct" required>
        <label for="motivoAct">Motivo (opcional)</label>
        <input type="text" id="motivoAct">
        <label for="fechaAct">Fecha</label>
        <input type="datetime-local" id="fechaAct" required>
        <label for="coordenadaAct">Coordenada</label>
        <input type="text" id="coordenadaAct" required>
        <button type="submit" class="btn">A√±adir Actualizaci√≥n</button>
      </form>
      <div class="table-section">
        <table class="data-table" id="tablaRastreo">
          <thead>
            <tr>
              <th>Ciudad</th>
              <th>Estado</th>
              <th>Motivo</th>
              <th>Fecha</th>
              <th>Coordenada</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    // Proteger acceso solo para admin logueado con JWT
    const token = localStorage.getItem('admin_token');
    if (!token) {
      window.location.href = 'login.html';
    }
    const API_BASE = 'https://databaseinterrapidisimo-production.up.railway.app';
    let documentoActual = null;
    let guiaActual = null;
    let rastreosPrevios = [];

    // --- Control General de Rastreos ---
    async function cargarControlGeneral() {
      try {
        document.getElementById('tablaControlGeneral').innerHTML = '<p class="loading-message">Cargando datos...</p>';
        const res = await fetch(`${API_BASE}/control-general`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('No se pudo cargar el control general');
        const datosAgrupados = await res.json();
        renderControlGeneral(datosAgrupados);
      } catch (err) {
        document.getElementById('tablaControlGeneral').innerHTML = `<p class="loading-message">Error: ${err.message}</p>`;
      }
    }

    function renderControlGeneral(datosAgrupados) {
      let totalRastreos = 0;
      let html = '';
      
      for (const [documento, rastreos] of Object.entries(datosAgrupados)) {
        totalRastreos += rastreos.length;
        html += `
          <div class="control-group">
            <div class="control-group-header">
              üìÅ Documento: ${documento} (${rastreos.length} rastreo${rastreos.length !== 1 ? 's' : ''})
            </div>
            <div class="control-group-content">
        `;
        
        rastreos.forEach(rastreo => {
          html += `
            <div class="control-item">
              <div class="control-field">
                <strong>Gu√≠a:</strong> ${rastreo.numero_guia}<br>
                <strong>Fecha:</strong> ${rastreo.admision || 'N/A'}
              </div>
              <div class="control-field">
                <strong>Origen:</strong> ${rastreo.origen_nombre || 'N/A'}<br>
                <strong>Ciudad:</strong> ${rastreo.origen_ciudad || 'N/A'}
              </div>
              <div class="control-field">
                <strong>Destino:</strong> ${rastreo.destino_nombre || 'N/A'}<br>
                <strong>Ciudad:</strong> ${rastreo.destino_ciudad || 'N/A'}
              </div>
              <div class="control-field">
                <strong>Estado:</strong> ${rastreo.ultimo_estado}<br>
                <strong>Ubicaci√≥n:</strong> ${rastreo.ultima_ciudad}
              </div>
              <div class="control-actions-buttons">
                <button class="btn btn-small btn-update" onclick="editarRastreoDesdeControl('${documento}', '${rastreo.numero_guia}')">
                  ‚úèÔ∏è Editar
                </button>
                <button class="btn btn-small btn-delete" onclick="eliminarRastreoDesdeControl(${rastreo.id})">
                  üóëÔ∏è Eliminar
                </button>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      }
      
      if (html === '') {
        html = '<p class="loading-message">No hay rastreos registrados</p>';
      }
      
      document.getElementById('tablaControlGeneral').innerHTML = html;
      document.getElementById('totalRastreos').textContent = `Total: ${totalRastreos} rastreo${totalRastreos !== 1 ? 's' : ''}`;
    }

    window.editarRastreoDesdeControl = async function(documento, numeroGuia) {
      // Llenar el campo documento y cargar rastreos
      document.getElementById('documento').value = documento;
      documentoActual = documento;
      await refreshRastreosPreviosAndSelect(numeroGuia);
      document.getElementById('formRastreo').style.display = '';
      
      // Scroll hacia el formulario
      document.getElementById('formRastreo').scrollIntoView({ behavior: 'smooth' });
    };

    window.eliminarRastreoDesdeControl = async function(id) {
      if (!confirm('¬øEst√° seguro de que desea eliminar este rastreo?')) return;
      try {
        const res = await fetch(`${API_BASE}/rastreos/actualizacion/${id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('No se pudo eliminar el rastreo');
        alert('Rastreo eliminado correctamente');
        cargarControlGeneral(); // Recargar la lista
      } catch (err) {
        alert('Error al eliminar: ' + err.message);
      }
    };

    // Evento para bot√≥n de refresh
    document.getElementById('btnRefreshControl').onclick = cargarControlGeneral;

    // Cargar control general al iniciar
    cargarControlGeneral();

    // --- Manejo de documento y rastreos previos ---
    document.getElementById('formDocumento').onsubmit = async function(e) {
      e.preventDefault();
      const doc = document.getElementById('documento').value.trim();
      if (!doc) return;
      documentoActual = doc;
      guiaActual = null;
      await refreshRastreosPreviosAndSelect();
      document.getElementById('formRastreo').style.display = '';
      document.getElementById('rastreoSection').style.display = 'none';
    };

    async function refreshRastreosPreviosAndSelect(guia) {
      try {
        const res = await fetch(`${API_BASE}/rastreos/${documentoActual}`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('No se pudo consultar rastreos');
        rastreosPrevios = await res.json();
        renderRastreosPrevios();
        document.getElementById('rastreosPrevios').style.display = rastreosPrevios.length ? '' : 'none';
        if (guia) {
          const idx = rastreosPrevios.findIndex(r => r.numero_guia === guia);
          if (idx !== -1) seleccionarRastreo(idx);
        }
      } catch (err) {
        rastreosPrevios = [];
        document.getElementById('rastreosPrevios').style.display = 'none';
        alert('Error al consultar rastreos: ' + (err.message || err));
      }
    }

    function renderRastreosPrevios() {
      const tbody = document.getElementById('tablaPrevios');
      tbody.innerHTML = '';
      rastreosPrevios.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.numero_guia}</td><td>${r.destino_ciudad || ''}</td><td><button class='btn' onclick='seleccionarRastreo(${idx})'>Seleccionar</button> <button class='btn btn-delete' onclick='eliminarRastreo(${idx})'>Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
    }

    window.seleccionarRastreo = function(idx) {
      const r = rastreosPrevios[idx];
      guiaActual = r.numero_guia;
      // Rellenar campos del formulario
      document.getElementById('guia').value = r.numero_guia;
      document.getElementById('admision').value = r.admision || '';
      document.getElementById('estimada').value = r.estimada || '';
      document.getElementById('destinoNombre').value = r.destino_nombre || '';
      document.getElementById('destinoCedula').value = r.destino_cedula || '';
      document.getElementById('destinoCiudad').value = r.destino_ciudad || '';
      document.getElementById('destinoDireccion').value = r.destino_direccion || '';
      document.getElementById('destinoTelefono').value = r.destino_telefono || '';
      document.getElementById('origenNombre').value = r.origen_nombre || '';
      document.getElementById('origenCiudad').value = r.origen_ciudad || '';
      document.getElementById('origenTelefono').value = r.origen_telefono || '';
      document.getElementById('origenCedula').value = r.origen_cedula || '';
      document.getElementById('origenDireccion').value = r.origen_direccion || '';
      document.getElementById('empaque').value = r.empaque || '';
      // Actualizaciones
      let acts = [];
      try { acts = JSON.parse(r.actualizaciones) || []; } catch { acts = []; }
      renderTabla(acts);
      document.getElementById('rastreoSection').style.display = '';
    };

    // --- Manejo de rastreo (crear) ---
    document.getElementById('formRastreo').onsubmit = async function(e) {
      e.preventDefault();
      if (!documentoActual) return;
      const guia = document.getElementById('guia').value.trim();
      if (!guia) return;
      guiaActual = guia;
      // Recolectar datos del formulario
      const rastreo = {
        numero_guia: guia,
        documento: documentoActual,
        admision: document.getElementById('admision').value,
        estimada: document.getElementById('estimada').value,
        destino_nombre: document.getElementById('destinoNombre').value,
        destino_cedula: document.getElementById('destinoCedula').value,
        destino_ciudad: document.getElementById('destinoCiudad').value,
        destino_direccion: document.getElementById('destinoDireccion').value,
        destino_telefono: document.getElementById('destinoTelefono').value,
        origen_nombre: document.getElementById('origenNombre').value,
        origen_ciudad: document.getElementById('origenCiudad').value,
        origen_telefono: document.getElementById('origenTelefono').value,
        origen_cedula: document.getElementById('origenCedula').value,
        origen_direccion: document.getElementById('origenDireccion').value,
        empaque: document.getElementById('empaque').value,
        actualizaciones: JSON.stringify([])
      };
      let existe = rastreosPrevios.find(r => r.numero_guia === guia);
      if (existe) {
        seleccionarRastreo(rastreosPrevios.findIndex(r => r.numero_guia === guia));
        alert('Ya existe un rastreo con esa gu√≠a. Selecci√≥nalo de la lista para editar actualizaciones.');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/rastreos`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          },
          body: JSON.stringify(rastreo)
        });
        if (!res.ok) throw new Error('No se pudo guardar el rastreo');
        await refreshRastreosPreviosAndSelect(guia);
        cargarControlGeneral(); // Actualizar control general
        alert('Gu√≠a a√±adida: ' + guia);
      } catch (err) {
        alert('Error al guardar el rastreo: ' + (err.message || err));
      }
    };

    // --- Manejo de actualizaciones de rastreo (PUT) ---
    document.getElementById('formActualizacion').onsubmit = async function(e) {
      e.preventDefault();
      if (!documentoActual || !guiaActual) return;
      const rastreo = rastreosPrevios.find(r => r.numero_guia === guiaActual);
      if (!rastreo) return alert('Seleccione un rastreo de la lista');
      let acts = [];
      try { acts = JSON.parse(rastreo.actualizaciones) || []; } catch { acts = []; }
      const act = {
        ciudad: document.getElementById('ciudadAct').value,
        estado: document.getElementById('estadoAct').value,
        motivo: document.getElementById('motivoAct').value,
        fecha: document.getElementById('fechaAct').value,
        coordenada: document.getElementById('coordenadaAct').value
      };
      acts.push(act);
      try {
        const res = await fetch(`${API_BASE}/rastreos/actualizacion/${rastreo.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          },
          body: JSON.stringify({ actualizaciones: JSON.stringify(acts) })
        });
        if (!res.ok) throw new Error('No se pudo actualizar');
        await refreshRastreosPreviosAndSelect(guiaActual);
        document.getElementById('formActualizacion').reset();
      } catch (err) {
        alert('Error al actualizar el rastreo: ' + (err.message || err));
      }
    };

    // --- Eliminar actualizaci√≥n ---
    window.eliminarActualizacion = async function(idx) {
      if (!documentoActual || !guiaActual) return;
      const rastreo = rastreosPrevios.find(r => r.numero_guia === guiaActual);
      if (!rastreo) return;
      let acts = [];
      try { acts = JSON.parse(rastreo.actualizaciones) || []; } catch { acts = []; }
      if (!confirm('¬øSeguro que desea eliminar esta actualizaci√≥n?')) return;
      acts.splice(idx, 1);
      try {
        const res = await fetch(`${API_BASE}/rastreos/actualizacion/${rastreo.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          },
          body: JSON.stringify({ actualizaciones: JSON.stringify(acts) })
        });
        if (!res.ok) throw new Error('No se pudo actualizar');
        await refreshRastreosPreviosAndSelect(guiaActual);
      } catch (err) {
        alert('Error al eliminar la actualizaci√≥n: ' + (err.message || err));
      }
    }

    window.eliminarRastreo = async function(idx) {
      if (!confirm('¬øSeguro que desea eliminar este rastreo?')) return;
      const rastreo = rastreosPrevios[idx];
      if (!rastreo) return;
      try {
        const res = await fetch(`${API_BASE}/rastreos/actualizacion/${rastreo.id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('No se pudo eliminar el rastreo');
        await refreshRastreosPreviosAndSelect();
        cargarControlGeneral(); // Actualizar control general
        document.getElementById('rastreoSection').style.display = 'none';
        guiaActual = null;
        alert('Rastreo eliminado correctamente.');
      } catch (err) {
        alert('Error al eliminar el rastreo: ' + (err.message || err));
      }
    }

    // --- Render tabla de actualizaciones ---
    function renderTabla(acts) {
      const tbody = document.querySelector('#tablaRastreo tbody');
      tbody.innerHTML = '';
      if (!documentoActual || !guiaActual) return;
      acts.forEach((a, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.ciudad}</td><td>${a.estado}</td><td>${a.motivo||''}</td><td>${a.fecha}</td><td>${a.coordenada}</td><td><button class='btn btn-delete' onclick='eliminarActualizacion(${idx})'>Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
